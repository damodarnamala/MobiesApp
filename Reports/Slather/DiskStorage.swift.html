<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>DiskStorage.swift - Slather</title>
<link href="slather.css" media="all" rel="stylesheet">
</head>
<body>
<header><div class="row"><a href="index.html"><img src="logo.jpg" alt="Slather logo"></a></div></header><div class="row"><div id="reports">
<h2 class="cov_title">
<span>Coverage for "DiskStorage.swift" : </span><span>Lines: </span><span class="cov_low">44.20%</span><span> Branches: </span><span class="cov_low">39.01%</span>
</h2>
<h4 class="cov_subtitle">(160 of 362 relevant lines covered)</h4>
<h4 class="cov_filepath">../../Library/Developer/Xcode/DerivedData/MoviesApp-giwrjipdrxodogcnlilxhhdbjkad/SourcePackages/checkouts/Kingfisher/Sources/Cache/DiskStorage.swift</h4>
<table class="source_code">
<tr class="never">
<td class="num">1</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">2</td>
<td class="src"><pre><code class="objc">//  DiskStorage.swift</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">3</td>
<td class="src"><pre><code class="objc">//  Kingfisher</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">4</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">5</td>
<td class="src"><pre><code class="objc">//  Created by Wei Wang on 2018/10/15.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">6</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">7</td>
<td class="src"><pre><code class="objc">//  Copyright (c) 2019 Wei Wang &lt;onevcat@gmail.com&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">8</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">9</td>
<td class="src"><pre><code class="objc">//  Permission is hereby granted, free of charge, to any person obtaining a copy</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">10</td>
<td class="src"><pre><code class="objc">//  of this software and associated documentation files (the "Software"), to deal</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">11</td>
<td class="src"><pre><code class="objc">//  in the Software without restriction, including without limitation the rights</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">12</td>
<td class="src"><pre><code class="objc">//  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">13</td>
<td class="src"><pre><code class="objc">//  copies of the Software, and to permit persons to whom the Software is</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">14</td>
<td class="src"><pre><code class="objc">//  furnished to do so, subject to the following conditions:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">15</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">16</td>
<td class="src"><pre><code class="objc">//  The above copyright notice and this permission notice shall be included in</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">17</td>
<td class="src"><pre><code class="objc">//  all copies or substantial portions of the Software.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">18</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">19</td>
<td class="src"><pre><code class="objc">//  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">20</td>
<td class="src"><pre><code class="objc">//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">21</td>
<td class="src"><pre><code class="objc">//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">22</td>
<td class="src"><pre><code class="objc">//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">23</td>
<td class="src"><pre><code class="objc">//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">24</td>
<td class="src"><pre><code class="objc">//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">25</td>
<td class="src"><pre><code class="objc">//  THE SOFTWARE.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">26</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">27</td>
<td class="src"><pre><code class="objc">import Foundation</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">28</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">29</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">30</td>
<td class="src"><pre><code class="objc">/// Represents a set of conception related to storage which stores a certain type of value in disk.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">31</td>
<td class="src"><pre><code class="objc">/// This is a namespace for the disk storage types. A `Backend` with a certain `Config` will be used to describe the</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">32</td>
<td class="src"><pre><code class="objc">/// storage. See these composed types for more information.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">33</td>
<td class="src"><pre><code class="objc">public enum DiskStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">34</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">35</td>
<td class="src"><pre><code class="objc">    /// Represents a storage back-end for the `DiskStorage`. The value is serialized to data</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">36</td>
<td class="src"><pre><code class="objc">    /// and stored as file in the file system under a specified location.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">37</td>
<td class="src"><pre><code class="objc">    ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">38</td>
<td class="src"><pre><code class="objc">    /// You can config a `DiskStorage.Backend` in its initializer by passing a `DiskStorage.Config` value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">39</td>
<td class="src"><pre><code class="objc">    /// or modifying the `config` property after it being created. `DiskStorage` will use file's attributes to keep</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">40</td>
<td class="src"><pre><code class="objc">    /// track of a file for its expiration or size limitation.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">41</td>
<td class="src"><pre><code class="objc">    public class Backend&lt;T: DataTransformable&gt; {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">42</td>
<td class="src"><pre><code class="objc">        /// The config used for this disk storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">43</td>
<td class="src"><pre><code class="objc">        public var config: Config</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">44</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">45</td>
<td class="src"><pre><code class="objc">        // The final storage URL on disk, with `name` and `cachePathBlock` considered.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">46</td>
<td class="src"><pre><code class="objc">        public let directoryURL: URL</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">47</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">48</td>
<td class="src"><pre><code class="objc">        let metaChangingQueue: DispatchQueue</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">49</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">50</td>
<td class="src"><pre><code class="objc">        var maybeCached : Set&lt;String&gt;?</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">51</td>
<td class="src"><pre><code class="objc">        let maybeCachedCheckingQueue = DispatchQueue(label: "com.onevcat.Kingfisher.maybeCachedCheckingQueue")</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">52</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">53</td>
<td class="src"><pre><code class="objc">        // `false` if the storage initialized with an error. This prevents unexpected forcibly crash when creating</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">54</td>
<td class="src"><pre><code class="objc">        // storage in the default cache.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">55</td>
<td class="src"><pre><code class="objc">        private var storageReady: Bool = true</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">56</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">57</td>
<td class="src"><pre><code class="objc">        /// Creates a disk storage with the given `DiskStorage.Config`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">58</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">59</td>
<td class="src"><pre><code class="objc">        /// - Parameter config: The config used for this disk storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">60</td>
<td class="src"><pre><code class="objc">        /// - Throws: An error if the folder for storage cannot be got or created.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">61</td>
<td class="src"><pre><code class="objc">        public convenience init(config: Config) throws {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">62</td>
<td class="src"><pre><code class="objc">            self.init(noThrowConfig: config, creatingDirectory: false)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">63</td>
<td class="src"><pre><code class="objc">            try prepareDirectory()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">64</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">65</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">66</td>
<td class="src"><pre><code class="objc">        // If `creatingDirectory` is `false`, the directory preparation will be skipped.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">67</td>
<td class="src"><pre><code class="objc">        // We need to call `prepareDirectory` manually after this returns.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">68</td>
<td class="src"><pre><code class="objc">        init(noThrowConfig config: Config, creatingDirectory: Bool) {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">69</td>
<td class="src"><pre><code class="objc">            var config = config</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">70</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">71</td>
<td class="src"><pre><code class="objc">            let creation = Creation(config)</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">72</td>
<td class="src"><pre><code class="objc">            self.directoryURL = creation.directoryURL</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">73</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">74</td>
<td class="src"><pre><code class="objc">            // Break any possible retain cycle set by outside.</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">75</td>
<td class="src"><pre><code class="objc">            config.cachePathBlock = nil</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">76</td>
<td class="src"><pre><code class="objc">            self.config = config</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">77</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">78</td>
<td class="src"><pre><code class="objc">            metaChangingQueue = DispatchQueue(label: creation.cacheName)</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">79</td>
<td class="src"><pre><code class="objc">            setupCacheChecking()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">80</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">81</td>
<td class="src"><pre><code class="objc">            if creatingDirectory {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">82</td>
<td class="src"><pre><code class="objc">                try? prepareDirectory()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">83</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">84</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">85</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">86</td>
<td class="src"><pre><code class="objc">        private func setupCacheChecking() {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">87</td>
<td class="src"><pre><code class="objc">            maybeCachedCheckingQueue.async {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">88</td>
<td class="src"><pre><code class="objc">                do {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">89</td>
<td class="src"><pre><code class="objc">                    self.maybeCached = Set()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">90</td>
<td class="src"><pre><code class="objc">                    try self.config.fileManager.contentsOfDirectory(atPath: self.directoryURL.path).forEach { fileName in</code></pre></td>
<td class="coverage">324x</td>
</tr>
<tr class="covered">
<td class="num">91</td>
<td class="src"><pre><code class="objc">                        self.maybeCached?.insert(fileName)</code></pre></td>
<td class="coverage">324x</td>
</tr>
<tr class="covered">
<td class="num">92</td>
<td class="src"><pre><code class="objc">                    }</code></pre></td>
<td class="coverage">324x</td>
</tr>
<tr class="covered">
<td class="num">93</td>
<td class="src"><pre><code class="objc">                } catch </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="missed">
<td class="num">94</td>
<td class="src"><pre><code class="objc">                    // Just disable the functionality if we fail to initialize it properly. This will just revert to</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">95</td>
<td class="src"><pre><code class="objc">                    // the behavior which is to check file existence on disk directly.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">96</td>
<td class="src"><pre><code class="objc">                    self.maybeCached = nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">97</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">98</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">99</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">100</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">101</td>
<td class="src"><pre><code class="objc">        // Creates the storage folder.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">102</td>
<td class="src"><pre><code class="objc">        private func prepareDirectory() throws {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">103</td>
<td class="src"><pre><code class="objc">            let fileManager = config.fileManager</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">104</td>
<td class="src"><pre><code class="objc">            let path = directoryURL.path</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">105</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">106</td>
<td class="src"><pre><code class="objc">            guard !fileManager.fileExists(atPath: path) else { return }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="missed">
<td class="num">107</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">108</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">109</td>
<td class="src"><pre><code class="objc">                try fileManager.createDirectory(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">110</td>
<td class="src"><pre><code class="objc">                    atPath: path,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">111</td>
<td class="src"><pre><code class="objc">                    withIntermediateDirectories: true,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">112</td>
<td class="src"><pre><code class="objc">                    attributes: nil)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">113</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">114</td>
<td class="src"><pre><code class="objc">                self.storageReady = false</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">115</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .cannotCreateDirectory(path: path, error: error))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">116</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">117</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">118</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">119</td>
<td class="src"><pre><code class="objc">        /// Stores a value to the storage under the specified key and expiration policy.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">120</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">121</td>
<td class="src"><pre><code class="objc">        ///   - value: The value to be stored.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">122</td>
<td class="src"><pre><code class="objc">        ///   - key: The key to which the `value` will be stored. If there is already a value under the key,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">123</td>
<td class="src"><pre><code class="objc">        ///          the old value will be overwritten by `value`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">124</td>
<td class="src"><pre><code class="objc">        ///   - expiration: The expiration policy used by this store action.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">125</td>
<td class="src"><pre><code class="objc">        ///   - writeOptions: Data writing options used the new files.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">126</td>
<td class="src"><pre><code class="objc">        /// - Throws: An error during converting the value to a data format or during writing it to disk.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">127</td>
<td class="src"><pre><code class="objc">        public func store(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">128</td>
<td class="src"><pre><code class="objc">            value: T,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">129</td>
<td class="src"><pre><code class="objc">            forKey key: String,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">130</td>
<td class="src"><pre><code class="objc">            expiration: StorageExpiration? = nil,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">131</td>
<td class="src"><pre><code class="objc">            writeOptions: Data.WritingOptions = []) throws</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">132</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">133</td>
<td class="src"><pre><code class="objc">            guard storageReady else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">134</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .diskStorageIsNotReady(cacheURL: directoryURL))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">135</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">136</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">137</td>
<td class="src"><pre><code class="objc">            let expiration = expiration ?? config.expiration</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">138</td>
<td class="src"><pre><code class="objc">            // The expiration indicates that already expired, no need to store.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">139</td>
<td class="src"><pre><code class="objc">            guard !expiration.isExpired else { return }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">140</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">141</td>
<td class="src"><pre><code class="objc">            let data: Data</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">142</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">143</td>
<td class="src"><pre><code class="objc">                data = try value.toData()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">144</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">145</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .cannotConvertToData(object: value, error: error))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">146</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">147</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">148</td>
<td class="src"><pre><code class="objc">            let fileURL = cacheFileURL(forKey: key)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">149</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">150</td>
<td class="src"><pre><code class="objc">                try data.write(to: fileURL, options: writeOptions)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">151</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">152</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">153</td>
<td class="src"><pre><code class="objc">                    reason: .cannotCreateCacheFile(fileURL: fileURL, key: key, data: data, error: error)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">154</td>
<td class="src"><pre><code class="objc">                )</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">155</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">156</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">157</td>
<td class="src"><pre><code class="objc">            let now = Date()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">158</td>
<td class="src"><pre><code class="objc">            let attributes: [FileAttributeKey : Any] = [</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">159</td>
<td class="src"><pre><code class="objc">                // The last access date.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">160</td>
<td class="src"><pre><code class="objc">                .creationDate: now.fileAttributeDate,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">161</td>
<td class="src"><pre><code class="objc">                // The estimated expiration date.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">162</td>
<td class="src"><pre><code class="objc">                .modificationDate: expiration.estimatedExpirationSinceNow.fileAttributeDate</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">163</td>
<td class="src"><pre><code class="objc">            ]</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">164</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">165</td>
<td class="src"><pre><code class="objc">                try config.fileManager.setAttributes(attributes, ofItemAtPath: fileURL.path)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">166</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">167</td>
<td class="src"><pre><code class="objc">                try? config.fileManager.removeItem(at: fileURL)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">168</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">169</td>
<td class="src"><pre><code class="objc">                    reason: .cannotSetCacheFileAttribute(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">170</td>
<td class="src"><pre><code class="objc">                        filePath: fileURL.path,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">171</td>
<td class="src"><pre><code class="objc">                        attributes: attributes,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">172</td>
<td class="src"><pre><code class="objc">                        error: error</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">173</td>
<td class="src"><pre><code class="objc">                    )</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">174</td>
<td class="src"><pre><code class="objc">                )</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">175</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">176</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">177</td>
<td class="src"><pre><code class="objc">            maybeCachedCheckingQueue.async {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">178</td>
<td class="src"><pre><code class="objc">                self.maybeCached?.insert(fileURL.lastPathComponent)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">179</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">180</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">181</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">182</td>
<td class="src"><pre><code class="objc">        /// Gets a value from the storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">183</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">184</td>
<td class="src"><pre><code class="objc">        ///   - key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">185</td>
<td class="src"><pre><code class="objc">        ///   - extendingExpiration: The expiration policy used by this getting action.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">186</td>
<td class="src"><pre><code class="objc">        /// - Throws: An error during converting the data to a value or during operation of disk files.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">187</td>
<td class="src"><pre><code class="objc">        /// - Returns: The value under `key` if it is valid and found in the storage. Otherwise, `nil`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">188</td>
<td class="src"><pre><code class="objc">        public func value(forKey key: String, extendingExpiration: ExpirationExtending = .cacheTime) throws -&gt; T? {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">189</td>
<td class="src"><pre><code class="objc">            return try value(forKey: key, referenceDate: Date(), actuallyLoad: true, extendingExpiration: extendingExpiration)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">190</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">191</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">192</td>
<td class="src"><pre><code class="objc">        func value(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">193</td>
<td class="src"><pre><code class="objc">            forKey key: String,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">194</td>
<td class="src"><pre><code class="objc">            referenceDate: Date,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">195</td>
<td class="src"><pre><code class="objc">            actuallyLoad: Bool,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">196</td>
<td class="src"><pre><code class="objc">            extendingExpiration: ExpirationExtending) throws -&gt; T?</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">197</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">198</td>
<td class="src"><pre><code class="objc">            guard storageReady else </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">199</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .diskStorageIsNotReady(cacheURL: directoryURL))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">200</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">201</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">202</td>
<td class="src"><pre><code class="objc">            let fileManager = config.fileManager</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">203</td>
<td class="src"><pre><code class="objc">            let fileURL = cacheFileURL(forKey: key)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">204</td>
<td class="src"><pre><code class="objc">            let filePath = fileURL.path</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">205</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">206</td>
<td class="src"><pre><code class="objc">            let fileMaybeCached = maybeCachedCheckingQueue.sync {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">207</td>
<td class="src"><pre><code class="objc">                return maybeCached?.contains(fileURL.lastPathComponent) ?? </code><code class="objc missed">true</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">208</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">209</td>
<td class="src"><pre><code class="objc">            guard fileMaybeCached else </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">210</td>
<td class="src"><pre><code class="objc">                return nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">211</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">212</td>
<td class="src"><pre><code class="objc">            guard fileManager.fileExists(atPath: filePath) else </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">213</td>
<td class="src"><pre><code class="objc">                return nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">214</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">215</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">216</td>
<td class="src"><pre><code class="objc">            let meta: FileMeta</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">217</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">218</td>
<td class="src"><pre><code class="objc">                let resourceKeys: Set&lt;URLResourceKey&gt; = [.contentModificationDateKey, .creationDateKey]</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">219</td>
<td class="src"><pre><code class="objc">                meta = try FileMeta(fileURL: fileURL, resourceKeys: resourceKeys)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">220</td>
<td class="src"><pre><code class="objc">            } catch </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">221</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">222</td>
<td class="src"><pre><code class="objc">                    reason: .invalidURLResource(error: error, key: key, url: fileURL))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">223</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">224</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">225</td>
<td class="src"><pre><code class="objc">            if meta.expired(referenceDate: referenceDate) </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">226</td>
<td class="src"><pre><code class="objc">                return nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">227</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">228</td>
<td class="src"><pre><code class="objc">            if !actuallyLoad { return T.empty }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">229</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">230</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">231</td>
<td class="src"><pre><code class="objc">                let data = try Data(contentsOf: fileURL)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">232</td>
<td class="src"><pre><code class="objc">                let obj = try T.fromData(data)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">233</td>
<td class="src"><pre><code class="objc">                metaChangingQueue.async {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">234</td>
<td class="src"><pre><code class="objc">                    meta.extendExpiration(with: fileManager, extendingExpiration: extendingExpiration)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">235</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">236</td>
<td class="src"><pre><code class="objc">                return obj</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">237</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">238</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .cannotLoadDataFromDisk(url: fileURL, error: error))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">239</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">240</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">241</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">242</td>
<td class="src"><pre><code class="objc">        /// Whether there is valid cached data under a given key.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">243</td>
<td class="src"><pre><code class="objc">        /// - Parameter key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">244</td>
<td class="src"><pre><code class="objc">        /// - Returns: If there is valid data under the key, `true`. Otherwise, `false`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">245</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">246</td>
<td class="src"><pre><code class="objc">        /// - Note:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">247</td>
<td class="src"><pre><code class="objc">        /// This method does not actually load the data from disk, so it is faster than directly loading the cached value</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">248</td>
<td class="src"><pre><code class="objc">        /// by checking the nullability of `value(forKey:extendingExpiration:)` method.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">249</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">250</td>
<td class="src"><pre><code class="objc">        public func isCached(forKey key: String) -&gt; Bool {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">251</td>
<td class="src"><pre><code class="objc">            return isCached(forKey: key, referenceDate: Date())</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">252</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">253</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">254</td>
<td class="src"><pre><code class="objc">        /// Whether there is valid cached data under a given key and a reference date.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">255</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">256</td>
<td class="src"><pre><code class="objc">        ///   - key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">257</td>
<td class="src"><pre><code class="objc">        ///   - referenceDate: A reference date to check whether the cache is still valid.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">258</td>
<td class="src"><pre><code class="objc">        /// - Returns: If there is valid data under the key, `true`. Otherwise, `false`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">259</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">260</td>
<td class="src"><pre><code class="objc">        /// - Note:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">261</td>
<td class="src"><pre><code class="objc">        /// If you pass `Date()` to `referenceDate`, this method is identical to `isCached(forKey:)`. Use the</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">262</td>
<td class="src"><pre><code class="objc">        /// `referenceDate` to determine whether the cache is still valid for a future date.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">263</td>
<td class="src"><pre><code class="objc">        public func isCached(forKey key: String, referenceDate: Date) -&gt; Bool {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">264</td>
<td class="src"><pre><code class="objc">            do {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">265</td>
<td class="src"><pre><code class="objc">                let result = try value(</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">266</td>
<td class="src"><pre><code class="objc">                    forKey: key,</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">267</td>
<td class="src"><pre><code class="objc">                    referenceDate: referenceDate,</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">268</td>
<td class="src"><pre><code class="objc">                    actuallyLoad: false,</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">269</td>
<td class="src"><pre><code class="objc">                    extendingExpiration: .none</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">270</td>
<td class="src"><pre><code class="objc">                )</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">271</td>
<td class="src"><pre><code class="objc">                return result != nil</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">272</td>
<td class="src"><pre><code class="objc">            } catch {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">273</td>
<td class="src"><pre><code class="objc">                return false</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">274</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">275</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">276</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">277</td>
<td class="src"><pre><code class="objc">        /// Removes a value from a specified key.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">278</td>
<td class="src"><pre><code class="objc">        /// - Parameter key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">279</td>
<td class="src"><pre><code class="objc">        /// - Throws: An error during removing the value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">280</td>
<td class="src"><pre><code class="objc">        public func remove(forKey key: String) throws {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">281</td>
<td class="src"><pre><code class="objc">            let fileURL = cacheFileURL(forKey: key)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">282</td>
<td class="src"><pre><code class="objc">            try removeFile(at: fileURL)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">283</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">284</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">285</td>
<td class="src"><pre><code class="objc">        func removeFile(at url: URL) throws {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">286</td>
<td class="src"><pre><code class="objc">            try config.fileManager.removeItem(at: url)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">287</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">288</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">289</td>
<td class="src"><pre><code class="objc">        /// Removes all values in this storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">290</td>
<td class="src"><pre><code class="objc">        /// - Throws: An error during removing the values.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">291</td>
<td class="src"><pre><code class="objc">        public func removeAll() throws {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">292</td>
<td class="src"><pre><code class="objc">            try removeAll(skipCreatingDirectory: false)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">293</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">294</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">295</td>
<td class="src"><pre><code class="objc">        func removeAll(skipCreatingDirectory: Bool) throws {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">296</td>
<td class="src"><pre><code class="objc">            try config.fileManager.removeItem(at: directoryURL)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">297</td>
<td class="src"><pre><code class="objc">            if !skipCreatingDirectory {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">298</td>
<td class="src"><pre><code class="objc">                try prepareDirectory()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">299</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">300</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">301</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">302</td>
<td class="src"><pre><code class="objc">        /// The URL of the cached file with a given computed `key`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">303</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">304</td>
<td class="src"><pre><code class="objc">        /// - Parameter key: The final computed key used when caching the image. Please note that usually this is not</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">305</td>
<td class="src"><pre><code class="objc">        /// the `cacheKey` of an image `Source`. It is the computed key with processor identifier considered.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">306</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">307</td>
<td class="src"><pre><code class="objc">        /// - Note:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">308</td>
<td class="src"><pre><code class="objc">        /// This method does not guarantee there is an image already cached in the returned URL. It just gives your</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">309</td>
<td class="src"><pre><code class="objc">        /// the URL that the image should be if it exists in disk storage, with the give key.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">310</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">311</td>
<td class="src"><pre><code class="objc">        public func cacheFileURL(forKey key: String) -&gt; URL {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">312</td>
<td class="src"><pre><code class="objc">            let fileName = cacheFileName(forKey: key)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">313</td>
<td class="src"><pre><code class="objc">            return directoryURL.appendingPathComponent(fileName, isDirectory: false)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">314</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="never">
<td class="num">315</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">316</td>
<td class="src"><pre><code class="objc">        func cacheFileName(forKey key: String) -&gt; String {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">317</td>
<td class="src"><pre><code class="objc">            if config.usesHashedFileName {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">318</td>
<td class="src"><pre><code class="objc">                let hashedKey = key.kf.md5</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">319</td>
<td class="src"><pre><code class="objc">                if let ext = config.pathExtension </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">320</td>
<td class="src"><pre><code class="objc">                    return "\(hashedKey).\(ext)"</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">321</td>
<td class="src"><pre><code class="objc">                } else if config.autoExtAfterHashedFileName,</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">322</td>
<td class="src"><pre><code class="objc">                          let ext = key.kf.ext </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">323</td>
<td class="src"><pre><code class="objc">                    return "\(hashedKey).\(ext)"</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">324</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">325</td>
<td class="src"><pre><code class="objc">                return hashedKey</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">326</td>
<td class="src"><pre><code class="objc">            } else {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="missed">
<td class="num">327</td>
<td class="src"><pre><code class="objc">                if let ext = config.pathExtension {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">328</td>
<td class="src"><pre><code class="objc">                    return "\(key).\(ext)"</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">329</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">330</td>
<td class="src"><pre><code class="objc">                return key</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">331</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">332</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">333</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">334</td>
<td class="src"><pre><code class="objc">        func allFileURLs(for propertyKeys: [URLResourceKey]) throws -&gt; [URL] {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">335</td>
<td class="src"><pre><code class="objc">            let fileManager = config.fileManager</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">336</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">337</td>
<td class="src"><pre><code class="objc">            guard let directoryEnumerator = fileManager.enumerator(</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">338</td>
<td class="src"><pre><code class="objc">                at: directoryURL, includingPropertiesForKeys: propertyKeys, options: .skipsHiddenFiles) else</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">339</td>
<td class="src"><pre><code class="objc">            {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">340</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .fileEnumeratorCreationFailed(url: directoryURL))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">341</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">342</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">343</td>
<td class="src"><pre><code class="objc">            guard let urls = directoryEnumerator.allObjects as? [URL] else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">344</td>
<td class="src"><pre><code class="objc">                throw KingfisherError.cacheError(reason: .invalidFileEnumeratorContent(url: directoryURL))</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">345</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">346</td>
<td class="src"><pre><code class="objc">            return urls</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">347</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">348</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">349</td>
<td class="src"><pre><code class="objc">        /// Removes all expired values from this storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">350</td>
<td class="src"><pre><code class="objc">        /// - Throws: A file manager error during removing the file.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">351</td>
<td class="src"><pre><code class="objc">        /// - Returns: The URLs for removed files.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">352</td>
<td class="src"><pre><code class="objc">        public func removeExpiredValues() throws -&gt; [URL] {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">353</td>
<td class="src"><pre><code class="objc">            return try removeExpiredValues(referenceDate: Date())</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">354</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">355</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">356</td>
<td class="src"><pre><code class="objc">        func removeExpiredValues(referenceDate: Date) throws -&gt; [URL] {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">357</td>
<td class="src"><pre><code class="objc">            let propertyKeys: [URLResourceKey] = [</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">358</td>
<td class="src"><pre><code class="objc">                .isDirectoryKey,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">359</td>
<td class="src"><pre><code class="objc">                .contentModificationDateKey</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">360</td>
<td class="src"><pre><code class="objc">            ]</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">361</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">362</td>
<td class="src"><pre><code class="objc">            let urls = try allFileURLs(for: propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">363</td>
<td class="src"><pre><code class="objc">            let keys = Set(propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">364</td>
<td class="src"><pre><code class="objc">            let expiredFiles = urls.filter { fileURL in</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">365</td>
<td class="src"><pre><code class="objc">                do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">366</td>
<td class="src"><pre><code class="objc">                    let meta = try FileMeta(fileURL: fileURL, resourceKeys: keys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">367</td>
<td class="src"><pre><code class="objc">                    if meta.isDirectory {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">368</td>
<td class="src"><pre><code class="objc">                        return false</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">369</td>
<td class="src"><pre><code class="objc">                    }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">370</td>
<td class="src"><pre><code class="objc">                    return meta.expired(referenceDate: referenceDate)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">371</td>
<td class="src"><pre><code class="objc">                } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">372</td>
<td class="src"><pre><code class="objc">                    return true</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">373</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">374</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">375</td>
<td class="src"><pre><code class="objc">            try expiredFiles.forEach { url in</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">376</td>
<td class="src"><pre><code class="objc">                try removeFile(at: url)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">377</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">378</td>
<td class="src"><pre><code class="objc">            return expiredFiles</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">379</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">380</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">381</td>
<td class="src"><pre><code class="objc">        /// Removes all size exceeded values from this storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">382</td>
<td class="src"><pre><code class="objc">        /// - Throws: A file manager error during removing the file.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">383</td>
<td class="src"><pre><code class="objc">        /// - Returns: The URLs for removed files.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">384</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">385</td>
<td class="src"><pre><code class="objc">        /// - Note: This method checks `config.sizeLimit` and remove cached files in an LRU (Least Recently Used) way.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">386</td>
<td class="src"><pre><code class="objc">        func removeSizeExceededValues() throws -&gt; [URL] {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">387</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">388</td>
<td class="src"><pre><code class="objc">            if config.sizeLimit == 0 { return [] } // Back compatible. 0 means no limit.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">389</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">390</td>
<td class="src"><pre><code class="objc">            var size = try totalSize()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">391</td>
<td class="src"><pre><code class="objc">            if size &lt; config.sizeLimit { return [] }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">392</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">393</td>
<td class="src"><pre><code class="objc">            let propertyKeys: [URLResourceKey] = [</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">394</td>
<td class="src"><pre><code class="objc">                .isDirectoryKey,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">395</td>
<td class="src"><pre><code class="objc">                .creationDateKey,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">396</td>
<td class="src"><pre><code class="objc">                .fileSizeKey</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">397</td>
<td class="src"><pre><code class="objc">            ]</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">398</td>
<td class="src"><pre><code class="objc">            let keys = Set(propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">399</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">400</td>
<td class="src"><pre><code class="objc">            let urls = try allFileURLs(for: propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">401</td>
<td class="src"><pre><code class="objc">            var pendings: [FileMeta] = urls.compactMap { fileURL in</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">402</td>
<td class="src"><pre><code class="objc">                guard let meta = try? FileMeta(fileURL: fileURL, resourceKeys: keys) else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">403</td>
<td class="src"><pre><code class="objc">                    return nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">404</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">405</td>
<td class="src"><pre><code class="objc">                return meta</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">406</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">407</td>
<td class="src"><pre><code class="objc">            // Sort by last access date. Most recent file first.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">408</td>
<td class="src"><pre><code class="objc">            pendings.sort(by: FileMeta.lastAccessDate)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">409</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">410</td>
<td class="src"><pre><code class="objc">            var removed: [URL] = []</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">411</td>
<td class="src"><pre><code class="objc">            let target = config.sizeLimit / 2</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">412</td>
<td class="src"><pre><code class="objc">            while size &gt; target, let meta = pendings.popLast() {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">413</td>
<td class="src"><pre><code class="objc">                size -= UInt(meta.fileSize)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">414</td>
<td class="src"><pre><code class="objc">                try removeFile(at: meta.url)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">415</td>
<td class="src"><pre><code class="objc">                removed.append(meta.url)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">416</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">417</td>
<td class="src"><pre><code class="objc">            return removed</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">418</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">419</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">420</td>
<td class="src"><pre><code class="objc">        /// Gets the total file size of the folder in bytes.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">421</td>
<td class="src"><pre><code class="objc">        public func totalSize() throws -&gt; UInt {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">422</td>
<td class="src"><pre><code class="objc">            let propertyKeys: [URLResourceKey] = [.fileSizeKey]</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">423</td>
<td class="src"><pre><code class="objc">            let urls = try allFileURLs(for: propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">424</td>
<td class="src"><pre><code class="objc">            let keys = Set(propertyKeys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">425</td>
<td class="src"><pre><code class="objc">            let totalSize: UInt = urls.reduce(0) { size, fileURL in</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">426</td>
<td class="src"><pre><code class="objc">                do {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">427</td>
<td class="src"><pre><code class="objc">                    let meta = try FileMeta(fileURL: fileURL, resourceKeys: keys)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">428</td>
<td class="src"><pre><code class="objc">                    return size + UInt(meta.fileSize)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">429</td>
<td class="src"><pre><code class="objc">                } catch {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">430</td>
<td class="src"><pre><code class="objc">                    return size</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">431</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">432</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">433</td>
<td class="src"><pre><code class="objc">            return totalSize</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">434</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">435</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">436</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">437</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">438</td>
<td class="src"><pre><code class="objc">extension DiskStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">439</td>
<td class="src"><pre><code class="objc">    /// Represents the config used in a `DiskStorage`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">440</td>
<td class="src"><pre><code class="objc">    public struct Config {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">441</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">442</td>
<td class="src"><pre><code class="objc">        /// The file size limit on disk of the storage in bytes. 0 means no limit.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">443</td>
<td class="src"><pre><code class="objc">        public var sizeLimit: UInt</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">444</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">445</td>
<td class="src"><pre><code class="objc">        /// The `StorageExpiration` used in this disk storage. Default is `.days(7)`,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">446</td>
<td class="src"><pre><code class="objc">        /// means that the disk cache would expire in one week.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">447</td>
<td class="src"><pre><code class="objc">        public var expiration: StorageExpiration = .days(7)</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">448</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">449</td>
<td class="src"><pre><code class="objc">        /// The preferred extension of cache item. It will be appended to the file name as its extension.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">450</td>
<td class="src"><pre><code class="objc">        /// Default is `nil`, means that the cache file does not contain a file extension.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">451</td>
<td class="src"><pre><code class="objc">        public var pathExtension: String? = nil</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">452</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">453</td>
<td class="src"><pre><code class="objc">        /// Default is `true`, means that the cache file name will be hashed before storing.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">454</td>
<td class="src"><pre><code class="objc">        public var usesHashedFileName = true</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">455</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">456</td>
<td class="src"><pre><code class="objc">        /// Default is `false`</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">457</td>
<td class="src"><pre><code class="objc">        /// If set to `true`, image extension will be extracted from original file name and append to</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">458</td>
<td class="src"><pre><code class="objc">        /// the hased file name and used as the cache key on disk.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">459</td>
<td class="src"><pre><code class="objc">        public var autoExtAfterHashedFileName = false</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">460</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">461</td>
<td class="src"><pre><code class="objc">        let name: String</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">462</td>
<td class="src"><pre><code class="objc">        let fileManager: FileManager</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">463</td>
<td class="src"><pre><code class="objc">        let directory: URL?</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">464</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">465</td>
<td class="src"><pre><code class="objc">        var cachePathBlock: ((_ directory: URL, _ cacheName: String) -&gt; URL)! = {</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="covered">
<td class="num">466</td>
<td class="src"><pre><code class="objc">            (directory, cacheName) in</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="covered">
<td class="num">467</td>
<td class="src"><pre><code class="objc">            return directory.appendingPathComponent(cacheName, isDirectory: true)</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="covered">
<td class="num">468</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">24x</td>
</tr>
<tr class="never">
<td class="num">469</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">470</td>
<td class="src"><pre><code class="objc">        /// Creates a config value based on given parameters.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">471</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">472</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">473</td>
<td class="src"><pre><code class="objc">        ///   - name: The name of cache. It is used as a part of storage folder. It is used to identify the disk</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">474</td>
<td class="src"><pre><code class="objc">        ///           storage. Two storages with the same `name` would share the same folder in disk, and it should</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">475</td>
<td class="src"><pre><code class="objc">        ///           be prevented.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">476</td>
<td class="src"><pre><code class="objc">        ///   - sizeLimit: The size limit in bytes for all existing files in the disk storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">477</td>
<td class="src"><pre><code class="objc">        ///   - fileManager: The `FileManager` used to manipulate files on disk. Default is `FileManager.default`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">478</td>
<td class="src"><pre><code class="objc">        ///   - directory: The URL where the disk storage should live. The storage will use this as the root folder,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">479</td>
<td class="src"><pre><code class="objc">        ///                and append a path which is constructed by input `name`. Default is `nil`, indicates that</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">480</td>
<td class="src"><pre><code class="objc">        ///                the cache directory under user domain mask will be used.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">481</td>
<td class="src"><pre><code class="objc">        public init(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">482</td>
<td class="src"><pre><code class="objc">            name: String,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">483</td>
<td class="src"><pre><code class="objc">            sizeLimit: UInt,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">484</td>
<td class="src"><pre><code class="objc">            fileManager: FileManager = .default,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">485</td>
<td class="src"><pre><code class="objc">            directory: URL? = nil)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">486</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">487</td>
<td class="src"><pre><code class="objc">            self.name = name</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">488</td>
<td class="src"><pre><code class="objc">            self.fileManager = fileManager</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">489</td>
<td class="src"><pre><code class="objc">            self.directory = directory</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">490</td>
<td class="src"><pre><code class="objc">            self.sizeLimit = sizeLimit</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">491</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">492</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">493</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">494</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">495</td>
<td class="src"><pre><code class="objc">extension DiskStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">496</td>
<td class="src"><pre><code class="objc">    struct FileMeta {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">497</td>
<td class="src"><pre><code class="objc">    </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">498</td>
<td class="src"><pre><code class="objc">        let url: URL</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">499</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">500</td>
<td class="src"><pre><code class="objc">        let lastAccessDate: Date?</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">501</td>
<td class="src"><pre><code class="objc">        let estimatedExpirationDate: Date?</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">502</td>
<td class="src"><pre><code class="objc">        let isDirectory: Bool</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">503</td>
<td class="src"><pre><code class="objc">        let fileSize: Int</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">504</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">505</td>
<td class="src"><pre><code class="objc">        static func lastAccessDate(lhs: FileMeta, rhs: FileMeta) -&gt; Bool {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">506</td>
<td class="src"><pre><code class="objc">            return lhs.lastAccessDate ?? .distantPast &gt; rhs.lastAccessDate ?? .distantPast</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">507</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">508</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">509</td>
<td class="src"><pre><code class="objc">        init(fileURL: URL, resourceKeys: Set&lt;URLResourceKey&gt;) throws {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">510</td>
<td class="src"><pre><code class="objc">            let meta = try fileURL.resourceValues(forKeys: resourceKeys)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">511</td>
<td class="src"><pre><code class="objc">            self.init(</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">512</td>
<td class="src"><pre><code class="objc">                fileURL: fileURL,</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">513</td>
<td class="src"><pre><code class="objc">                lastAccessDate: meta.creationDate,</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">514</td>
<td class="src"><pre><code class="objc">                estimatedExpirationDate: meta.contentModificationDate,</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">515</td>
<td class="src"><pre><code class="objc">                isDirectory: meta.isDirectory ?? false,</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">516</td>
<td class="src"><pre><code class="objc">                fileSize: meta.fileSize ?? 0)</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">517</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="never">
<td class="num">518</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">519</td>
<td class="src"><pre><code class="objc">        init(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">520</td>
<td class="src"><pre><code class="objc">            fileURL: URL,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">521</td>
<td class="src"><pre><code class="objc">            lastAccessDate: Date?,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">522</td>
<td class="src"><pre><code class="objc">            estimatedExpirationDate: Date?,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">523</td>
<td class="src"><pre><code class="objc">            isDirectory: Bool,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">524</td>
<td class="src"><pre><code class="objc">            fileSize: Int)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">525</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">526</td>
<td class="src"><pre><code class="objc">            self.url = fileURL</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">527</td>
<td class="src"><pre><code class="objc">            self.lastAccessDate = lastAccessDate</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">528</td>
<td class="src"><pre><code class="objc">            self.estimatedExpirationDate = estimatedExpirationDate</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">529</td>
<td class="src"><pre><code class="objc">            self.isDirectory = isDirectory</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">530</td>
<td class="src"><pre><code class="objc">            self.fileSize = fileSize</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">531</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="never">
<td class="num">532</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">533</td>
<td class="src"><pre><code class="objc">        func expired(referenceDate: Date) -&gt; Bool {</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">534</td>
<td class="src"><pre><code class="objc">            return estimatedExpirationDate?.isPast(referenceDate: referenceDate) ?? </code><code class="objc missed">true</code><code class="objc"></code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">535</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="never">
<td class="num">536</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">537</td>
<td class="src"><pre><code class="objc">        func extendExpiration(with fileManager: FileManager, extendingExpiration: ExpirationExtending) {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">538</td>
<td class="src"><pre><code class="objc">            guard let lastAccessDate = lastAccessDate,</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">539</td>
<td class="src"><pre><code class="objc">                  let lastEstimatedExpiration = estimatedExpirationDate else</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">540</td>
<td class="src"><pre><code class="objc">            </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">541</td>
<td class="src"><pre><code class="objc">                return</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">542</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">543</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">544</td>
<td class="src"><pre><code class="objc">            let attributes: [FileAttributeKey : Any]</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">545</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">546</td>
<td class="src"><pre><code class="objc">            switch extendingExpiration {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">547</td>
<td class="src"><pre><code class="objc">            </code><code class="objc missed">case .none:</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">548</td>
<td class="src"><pre><code class="objc">                // not extending expiration time here</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">549</td>
<td class="src"><pre><code class="objc">                return</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">550</td>
<td class="src"><pre><code class="objc">            case .cacheTime:</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">551</td>
<td class="src"><pre><code class="objc">                let originalExpiration: StorageExpiration =</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">552</td>
<td class="src"><pre><code class="objc">                    .seconds(lastEstimatedExpiration.timeIntervalSince(lastAccessDate))</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">553</td>
<td class="src"><pre><code class="objc">                attributes = [</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">554</td>
<td class="src"><pre><code class="objc">                    .creationDate: Date().fileAttributeDate,</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">555</td>
<td class="src"><pre><code class="objc">                    .modificationDate: originalExpiration.estimatedExpirationSinceNow.fileAttributeDate</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">556</td>
<td class="src"><pre><code class="objc">                ]</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">557</td>
<td class="src"><pre><code class="objc">            </code><code class="objc missed">case .expirationTime(let expirationTime):</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">558</td>
<td class="src"><pre><code class="objc">                attributes = [</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">559</td>
<td class="src"><pre><code class="objc">                    .creationDate: Date().fileAttributeDate,</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">560</td>
<td class="src"><pre><code class="objc">                    .modificationDate: expirationTime.estimatedExpirationSinceNow.fileAttributeDate</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">561</td>
<td class="src"><pre><code class="objc">                ]</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">562</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">563</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">564</td>
<td class="src"><pre><code class="objc">            try? fileManager.setAttributes(attributes, ofItemAtPath: url.path)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">565</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">566</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">567</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">568</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">569</td>
<td class="src"><pre><code class="objc">extension DiskStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">570</td>
<td class="src"><pre><code class="objc">    struct Creation {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">571</td>
<td class="src"><pre><code class="objc">        let directoryURL: URL</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">572</td>
<td class="src"><pre><code class="objc">        let cacheName: String</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">573</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">574</td>
<td class="src"><pre><code class="objc">        init(_ config: Config) {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">575</td>
<td class="src"><pre><code class="objc">            let url: URL</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">576</td>
<td class="src"><pre><code class="objc">            if let directory = config.directory </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="missed">
<td class="num">577</td>
<td class="src"><pre><code class="objc">                url = directory</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">578</td>
<td class="src"><pre><code class="objc">            } else {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">579</td>
<td class="src"><pre><code class="objc">                url = config.fileManager.urls(for: .cachesDirectory, in: .userDomainMask)[0]</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">580</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">581</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">582</td>
<td class="src"><pre><code class="objc">            cacheName = "com.onevcat.Kingfisher.ImageCache.\(config.name)"</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">583</td>
<td class="src"><pre><code class="objc">            directoryURL = config.cachePathBlock(url, cacheName)</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">584</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">585</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">586</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
</table>
</div></div>
<footer><div class="row">
<p><a href="https://github.com/SlatherOrg/slather">Fork me on Github</a></p>
<p>&copy; 2022 Slather</p>
</div></footer><script src="highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
