<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
<title>MemoryStorage.swift - Slather</title>
<link href="slather.css" media="all" rel="stylesheet">
</head>
<body>
<header><div class="row"><a href="index.html"><img src="logo.jpg" alt="Slather logo"></a></div></header><div class="row"><div id="reports">
<h2 class="cov_title">
<span>Coverage for "MemoryStorage.swift" : </span><span>Lines: </span><span class="cov_low">59.22%</span><span> Branches: </span><span class="cov_low">62.75%</span>
</h2>
<h4 class="cov_subtitle">(61 of 103 relevant lines covered)</h4>
<h4 class="cov_filepath">../../Library/Developer/Xcode/DerivedData/MoviesApp-giwrjipdrxodogcnlilxhhdbjkad/SourcePackages/checkouts/Kingfisher/Sources/Cache/MemoryStorage.swift</h4>
<table class="source_code">
<tr class="never">
<td class="num">1</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">2</td>
<td class="src"><pre><code class="objc">//  MemoryStorage.swift</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">3</td>
<td class="src"><pre><code class="objc">//  Kingfisher</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">4</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">5</td>
<td class="src"><pre><code class="objc">//  Created by Wei Wang on 2018/10/15.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">6</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">7</td>
<td class="src"><pre><code class="objc">//  Copyright (c) 2019 Wei Wang &lt;onevcat@gmail.com&gt;</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">8</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">9</td>
<td class="src"><pre><code class="objc">//  Permission is hereby granted, free of charge, to any person obtaining a copy</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">10</td>
<td class="src"><pre><code class="objc">//  of this software and associated documentation files (the "Software"), to deal</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">11</td>
<td class="src"><pre><code class="objc">//  in the Software without restriction, including without limitation the rights</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">12</td>
<td class="src"><pre><code class="objc">//  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">13</td>
<td class="src"><pre><code class="objc">//  copies of the Software, and to permit persons to whom the Software is</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">14</td>
<td class="src"><pre><code class="objc">//  furnished to do so, subject to the following conditions:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">15</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">16</td>
<td class="src"><pre><code class="objc">//  The above copyright notice and this permission notice shall be included in</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">17</td>
<td class="src"><pre><code class="objc">//  all copies or substantial portions of the Software.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">18</td>
<td class="src"><pre><code class="objc">//</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">19</td>
<td class="src"><pre><code class="objc">//  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">20</td>
<td class="src"><pre><code class="objc">//  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">21</td>
<td class="src"><pre><code class="objc">//  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">22</td>
<td class="src"><pre><code class="objc">//  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">23</td>
<td class="src"><pre><code class="objc">//  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">24</td>
<td class="src"><pre><code class="objc">//  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">25</td>
<td class="src"><pre><code class="objc">//  THE SOFTWARE.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">26</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">27</td>
<td class="src"><pre><code class="objc">import Foundation</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">28</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">29</td>
<td class="src"><pre><code class="objc">/// Represents a set of conception related to storage which stores a certain type of value in memory.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">30</td>
<td class="src"><pre><code class="objc">/// This is a namespace for the memory storage types. A `Backend` with a certain `Config` will be used to describe the</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">31</td>
<td class="src"><pre><code class="objc">/// storage. See these composed types for more information.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">32</td>
<td class="src"><pre><code class="objc">public enum MemoryStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">33</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">34</td>
<td class="src"><pre><code class="objc">    /// Represents a storage which stores a certain type of value in memory. It provides fast access,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">35</td>
<td class="src"><pre><code class="objc">    /// but limited storing size. The stored value type needs to conform to `CacheCostCalculable`,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">36</td>
<td class="src"><pre><code class="objc">    /// and its `cacheCost` will be used to determine the cost of size for the cache item.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">37</td>
<td class="src"><pre><code class="objc">    ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">38</td>
<td class="src"><pre><code class="objc">    /// You can config a `MemoryStorage.Backend` in its initializer by passing a `MemoryStorage.Config` value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">39</td>
<td class="src"><pre><code class="objc">    /// or modifying the `config` property after it being created. The backend of `MemoryStorage` has</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">40</td>
<td class="src"><pre><code class="objc">    /// upper limitation on cost size in memory and item count. All items in the storage has an expiration</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">41</td>
<td class="src"><pre><code class="objc">    /// date. When retrieved, if the target item is already expired, it will be recognized as it does not</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">42</td>
<td class="src"><pre><code class="objc">    /// exist in the storage. The `MemoryStorage` also contains a scheduled self clean task, to evict expired</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">43</td>
<td class="src"><pre><code class="objc">    /// items from memory.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">44</td>
<td class="src"><pre><code class="objc">    public class Backend&lt;T: CacheCostCalculable&gt; {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">45</td>
<td class="src"><pre><code class="objc">        let storage = NSCache&lt;NSString, StorageObject&lt;T&gt;&gt;()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">46</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">47</td>
<td class="src"><pre><code class="objc">        // Keys trackes the objects once inside the storage. For object removing triggered by user, the corresponding</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">48</td>
<td class="src"><pre><code class="objc">        // key would be also removed. However, for the object removing triggered by cache rule/policy of system, the</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">49</td>
<td class="src"><pre><code class="objc">        // key will be remained there until next `removeExpired` happens.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">50</td>
<td class="src"><pre><code class="objc">        //</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">51</td>
<td class="src"><pre><code class="objc">        // Breaking the strict tracking could save additional locking behaviors.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">52</td>
<td class="src"><pre><code class="objc">        // See https://github.com/onevcat/Kingfisher/issues/1233</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">53</td>
<td class="src"><pre><code class="objc">        var keys = Set&lt;String&gt;()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">54</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">55</td>
<td class="src"><pre><code class="objc">        private var cleanTimer: Timer? = nil</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">56</td>
<td class="src"><pre><code class="objc">        private let lock = NSLock()</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">57</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">58</td>
<td class="src"><pre><code class="objc">        /// The config used in this storage. It is a value you can set and</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">59</td>
<td class="src"><pre><code class="objc">        /// use to config the storage in air.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">60</td>
<td class="src"><pre><code class="objc">        public var config: Config {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">61</td>
<td class="src"><pre><code class="objc">            didSet {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">62</td>
<td class="src"><pre><code class="objc">                storage.totalCostLimit = config.totalCostLimit</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">63</td>
<td class="src"><pre><code class="objc">                storage.countLimit = config.countLimit</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">64</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">65</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">66</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">67</td>
<td class="src"><pre><code class="objc">        /// Creates a `MemoryStorage` with a given `config`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">68</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">69</td>
<td class="src"><pre><code class="objc">        /// - Parameter config: The config used to create the storage. It determines the max size limitation,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">70</td>
<td class="src"><pre><code class="objc">        ///                     default expiration setting and more.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">71</td>
<td class="src"><pre><code class="objc">        public init(config: Config) {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">72</td>
<td class="src"><pre><code class="objc">            self.config = config</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">73</td>
<td class="src"><pre><code class="objc">            storage.totalCostLimit = config.totalCostLimit</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">74</td>
<td class="src"><pre><code class="objc">            storage.countLimit = config.countLimit</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">75</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">76</td>
<td class="src"><pre><code class="objc">            cleanTimer = .scheduledTimer(withTimeInterval: config.cleanInterval, repeats: true) { [weak self] _ in</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="missed">
<td class="num">77</td>
<td class="src"><pre><code class="objc">                guard let self = self else { return }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">78</td>
<td class="src"><pre><code class="objc">                self.removeExpired()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">79</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">80</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">81</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">82</td>
<td class="src"><pre><code class="objc">        /// Removes the expired values from the storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">83</td>
<td class="src"><pre><code class="objc">        public func removeExpired() {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">84</td>
<td class="src"><pre><code class="objc">            lock.lock()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">85</td>
<td class="src"><pre><code class="objc">            defer { lock.unlock() }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">86</td>
<td class="src"><pre><code class="objc">            for key in keys {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">87</td>
<td class="src"><pre><code class="objc">                let nsKey = key as NSString</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">88</td>
<td class="src"><pre><code class="objc">                guard let object = storage.object(forKey: nsKey) else {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">89</td>
<td class="src"><pre><code class="objc">                    // This could happen if the object is moved by cache `totalCostLimit` or `countLimit` rule.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">90</td>
<td class="src"><pre><code class="objc">                    // We didn't remove the key yet until now, since we do not want to introduce additional lock.</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">91</td>
<td class="src"><pre><code class="objc">                    // See https://github.com/onevcat/Kingfisher/issues/1233</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">92</td>
<td class="src"><pre><code class="objc">                    keys.remove(key)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">93</td>
<td class="src"><pre><code class="objc">                    continue</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">94</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">95</td>
<td class="src"><pre><code class="objc">                if object.estimatedExpiration.isPast {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">96</td>
<td class="src"><pre><code class="objc">                    storage.removeObject(forKey: nsKey)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">97</td>
<td class="src"><pre><code class="objc">                    keys.remove(key)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">98</td>
<td class="src"><pre><code class="objc">                }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">99</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">100</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">101</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">102</td>
<td class="src"><pre><code class="objc">        /// Stores a value to the storage under the specified key and expiration policy.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">103</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">104</td>
<td class="src"><pre><code class="objc">        ///   - value: The value to be stored.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">105</td>
<td class="src"><pre><code class="objc">        ///   - key: The key to which the `value` will be stored.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">106</td>
<td class="src"><pre><code class="objc">        ///   - expiration: The expiration policy used by this store action.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">107</td>
<td class="src"><pre><code class="objc">        /// - Throws: No error will</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">108</td>
<td class="src"><pre><code class="objc">        public func store(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">109</td>
<td class="src"><pre><code class="objc">            value: T,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">110</td>
<td class="src"><pre><code class="objc">            forKey key: String,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">111</td>
<td class="src"><pre><code class="objc">            expiration: StorageExpiration? = nil)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">112</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">113</td>
<td class="src"><pre><code class="objc">            storeNoThrow(value: value, forKey: key, expiration: expiration)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">114</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">115</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">116</td>
<td class="src"><pre><code class="objc">        // The no throw version for storing value in cache. Kingfisher knows the detail so it</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">117</td>
<td class="src"><pre><code class="objc">        // could use this version to make syntax simpler internally.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">118</td>
<td class="src"><pre><code class="objc">        func storeNoThrow(</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">119</td>
<td class="src"><pre><code class="objc">            value: T,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">120</td>
<td class="src"><pre><code class="objc">            forKey key: String,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">121</td>
<td class="src"><pre><code class="objc">            expiration: StorageExpiration? = nil)</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">122</td>
<td class="src"><pre><code class="objc">        {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">123</td>
<td class="src"><pre><code class="objc">            lock.lock()</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">124</td>
<td class="src"><pre><code class="objc">            defer { lock.unlock() }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">125</td>
<td class="src"><pre><code class="objc">            let expiration = expiration ?? config.expiration</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">126</td>
<td class="src"><pre><code class="objc">            // The expiration indicates that already expired, no need to store.</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">127</td>
<td class="src"><pre><code class="objc">            guard !expiration.isExpired else </code><code class="objc missed">{ return }</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">128</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">129</td>
<td class="src"><pre><code class="objc">            let object = StorageObject(value, key: key, expiration: expiration)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">130</td>
<td class="src"><pre><code class="objc">            storage.setObject(object, forKey: key as NSString, cost: value.cacheCost)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">131</td>
<td class="src"><pre><code class="objc">            keys.insert(key)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">132</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">133</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">134</td>
<td class="src"><pre><code class="objc">        /// Gets a value from the storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">135</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">136</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">137</td>
<td class="src"><pre><code class="objc">        ///   - key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">138</td>
<td class="src"><pre><code class="objc">        ///   - extendingExpiration: The expiration policy used by this getting action.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">139</td>
<td class="src"><pre><code class="objc">        /// - Returns: The value under `key` if it is valid and found in the storage. Otherwise, `nil`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">140</td>
<td class="src"><pre><code class="objc">        public func value(forKey key: String, extendingExpiration: ExpirationExtending = .cacheTime) -&gt; T? {</code></pre></td>
<td class="coverage">354x</td>
</tr>
<tr class="covered">
<td class="num">141</td>
<td class="src"><pre><code class="objc">            guard let object = storage.object(forKey: key as NSString) else {</code></pre></td>
<td class="coverage">354x</td>
</tr>
<tr class="covered">
<td class="num">142</td>
<td class="src"><pre><code class="objc">                return nil</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">143</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">236x</td>
</tr>
<tr class="covered">
<td class="num">144</td>
<td class="src"><pre><code class="objc">            if object.expired </code><code class="objc missed">{</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">145</td>
<td class="src"><pre><code class="objc">                return nil</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">146</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">147</td>
<td class="src"><pre><code class="objc">            object.extendExpiration(extendingExpiration)</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">148</td>
<td class="src"><pre><code class="objc">            return object.value</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">149</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">150</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">151</td>
<td class="src"><pre><code class="objc">        /// Whether there is valid cached data under a given key.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">152</td>
<td class="src"><pre><code class="objc">        /// - Parameter key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">153</td>
<td class="src"><pre><code class="objc">        /// - Returns: If there is valid data under the key, `true`. Otherwise, `false`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">154</td>
<td class="src"><pre><code class="objc">        public func isCached(forKey key: String) -&gt; Bool {</code></pre></td>
<td class="coverage">177x</td>
</tr>
<tr class="covered">
<td class="num">155</td>
<td class="src"><pre><code class="objc">            guard let _ = value(forKey: key, extendingExpiration: .none) else {</code></pre></td>
<td class="coverage">177x</td>
</tr>
<tr class="covered">
<td class="num">156</td>
<td class="src"><pre><code class="objc">                return false</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">157</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">158</td>
<td class="src"><pre><code class="objc">            return true</code></pre></td>
<td class="coverage">59x</td>
</tr>
<tr class="covered">
<td class="num">159</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">177x</td>
</tr>
<tr class="never">
<td class="num">160</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">161</td>
<td class="src"><pre><code class="objc">        /// Removes a value from a specified key.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">162</td>
<td class="src"><pre><code class="objc">        /// - Parameter key: The cache key of value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">163</td>
<td class="src"><pre><code class="objc">        public func remove(forKey key: String) {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">164</td>
<td class="src"><pre><code class="objc">            lock.lock()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">165</td>
<td class="src"><pre><code class="objc">            defer { lock.unlock() }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">166</td>
<td class="src"><pre><code class="objc">            storage.removeObject(forKey: key as NSString)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">167</td>
<td class="src"><pre><code class="objc">            keys.remove(key)</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">168</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">169</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">170</td>
<td class="src"><pre><code class="objc">        /// Removes all values in this storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="missed">
<td class="num">171</td>
<td class="src"><pre><code class="objc">        public func removeAll() {</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">172</td>
<td class="src"><pre><code class="objc">            lock.lock()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">173</td>
<td class="src"><pre><code class="objc">            defer { lock.unlock() }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">174</td>
<td class="src"><pre><code class="objc">            storage.removeAllObjects()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">175</td>
<td class="src"><pre><code class="objc">            keys.removeAll()</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="missed">
<td class="num">176</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="never">
<td class="num">177</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">178</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">179</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">180</td>
<td class="src"><pre><code class="objc">extension MemoryStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">181</td>
<td class="src"><pre><code class="objc">    /// Represents the config used in a `MemoryStorage`.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">182</td>
<td class="src"><pre><code class="objc">    public struct Config {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">183</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">184</td>
<td class="src"><pre><code class="objc">        /// Total cost limit of the storage in bytes.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">185</td>
<td class="src"><pre><code class="objc">        public var totalCostLimit: Int</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">186</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">187</td>
<td class="src"><pre><code class="objc">        /// The item count limit of the memory storage.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">188</td>
<td class="src"><pre><code class="objc">        public var countLimit: Int = .max</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">189</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">190</td>
<td class="src"><pre><code class="objc">        /// The `StorageExpiration` used in this memory storage. Default is `.seconds(300)`,</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">191</td>
<td class="src"><pre><code class="objc">        /// means that the memory cache would expire in 5 minutes.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">192</td>
<td class="src"><pre><code class="objc">        public var expiration: StorageExpiration = .seconds(300)</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">193</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">194</td>
<td class="src"><pre><code class="objc">        /// The time interval between the storage do clean work for swiping expired items.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">195</td>
<td class="src"><pre><code class="objc">        public let cleanInterval: TimeInterval</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">196</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">197</td>
<td class="src"><pre><code class="objc">        /// Creates a config from a given `totalCostLimit` value.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">198</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">199</td>
<td class="src"><pre><code class="objc">        /// - Parameters:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">200</td>
<td class="src"><pre><code class="objc">        ///   - totalCostLimit: Total cost limit of the storage in bytes.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">201</td>
<td class="src"><pre><code class="objc">        ///   - cleanInterval: The time interval between the storage do clean work for swiping expired items.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">202</td>
<td class="src"><pre><code class="objc">        ///                    Default is 120, means the auto eviction happens once per two minutes.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">203</td>
<td class="src"><pre><code class="objc">        ///</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">204</td>
<td class="src"><pre><code class="objc">        /// - Note:</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">205</td>
<td class="src"><pre><code class="objc">        /// Other members of `MemoryStorage.Config` will use their default values when created.</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">206</td>
<td class="src"><pre><code class="objc">        public init(totalCostLimit: Int, cleanInterval: TimeInterval = 120) {</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">207</td>
<td class="src"><pre><code class="objc">            self.totalCostLimit = totalCostLimit</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">208</td>
<td class="src"><pre><code class="objc">            self.cleanInterval = cleanInterval</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="covered">
<td class="num">209</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">12x</td>
</tr>
<tr class="never">
<td class="num">210</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">211</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">212</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">213</td>
<td class="src"><pre><code class="objc">extension MemoryStorage {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">214</td>
<td class="src"><pre><code class="objc">    class StorageObject&lt;T&gt; {</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">215</td>
<td class="src"><pre><code class="objc">        let value: T</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">216</td>
<td class="src"><pre><code class="objc">        let expiration: StorageExpiration</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">217</td>
<td class="src"><pre><code class="objc">        let key: String</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">218</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">219</td>
<td class="src"><pre><code class="objc">        private(set) var estimatedExpiration: Date</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">220</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">221</td>
<td class="src"><pre><code class="objc">        init(_ value: T, key: String, expiration: StorageExpiration) {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">222</td>
<td class="src"><pre><code class="objc">            self.value = value</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">223</td>
<td class="src"><pre><code class="objc">            self.key = key</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">224</td>
<td class="src"><pre><code class="objc">            self.expiration = expiration</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">225</td>
<td class="src"><pre><code class="objc">            </code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">226</td>
<td class="src"><pre><code class="objc">            self.estimatedExpiration = expiration.estimatedExpirationSinceNow</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">227</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">228</td>
<td class="src"><pre><code class="objc"></code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">229</td>
<td class="src"><pre><code class="objc">        func extendExpiration(_ extendingExpiration: ExpirationExtending = .cacheTime) {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">230</td>
<td class="src"><pre><code class="objc">            switch extendingExpiration {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">231</td>
<td class="src"><pre><code class="objc">            case .none:</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">232</td>
<td class="src"><pre><code class="objc">                return</code></pre></td>
<td class="coverage">59x</td>
</tr>
<tr class="covered">
<td class="num">233</td>
<td class="src"><pre><code class="objc">            case .cacheTime:</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">234</td>
<td class="src"><pre><code class="objc">                self.estimatedExpiration = expiration.estimatedExpirationSinceNow</code></pre></td>
<td class="coverage">59x</td>
</tr>
<tr class="covered">
<td class="num">235</td>
<td class="src"><pre><code class="objc">            </code><code class="objc missed">case .expirationTime(let expirationTime):</code><code class="objc"></code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="missed">
<td class="num">236</td>
<td class="src"><pre><code class="objc">                self.estimatedExpiration = expirationTime.estimatedExpirationSinceNow</code></pre></td>
<td class="coverage">!</td>
</tr>
<tr class="covered">
<td class="num">237</td>
<td class="src"><pre><code class="objc">            }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">238</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">239</td>
<td class="src"><pre><code class="objc">        </code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="covered">
<td class="num">240</td>
<td class="src"><pre><code class="objc">        var expired: Bool {</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">241</td>
<td class="src"><pre><code class="objc">            return estimatedExpiration.isPast</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="covered">
<td class="num">242</td>
<td class="src"><pre><code class="objc">        }</code></pre></td>
<td class="coverage">118x</td>
</tr>
<tr class="never">
<td class="num">243</td>
<td class="src"><pre><code class="objc">    }</code></pre></td>
<td class="coverage"></td>
</tr>
<tr class="never">
<td class="num">244</td>
<td class="src"><pre><code class="objc">}</code></pre></td>
<td class="coverage"></td>
</tr>
</table>
</div></div>
<footer><div class="row">
<p><a href="https://github.com/SlatherOrg/slather">Fork me on Github</a></p>
<p>&copy; 2022 Slather</p>
</div></footer><script src="highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
